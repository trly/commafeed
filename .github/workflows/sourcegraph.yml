name: Sourcegraph

on:
  push:
    branches:
      - master
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  scip-java:
    name: SCIP Java Index
    runs-on: ubuntu-latest
    timeout-minutes: 60
    container:
      image: sourcegraph/scip-java:latest
    env:
      JVM_VERSION: 21
    steps:
      - name: Check Out Code
        uses: actions/checkout@v6

      - name: Generate SCIP Index
        run: scip-java index

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: scip-java-index
          path: index.scip
          retention-days: 1

  scip-typescript:
    name: SCIP TypeScript Index
    runs-on: ubuntu-latest
    timeout-minutes: 30
    defaults:
      run:
        working-directory: commafeed-client
    steps:
      - name: Check Out Code
        uses: actions/checkout@v6

      - name: Set Up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dependencies
        run: npm install

      - name: Install scip-typescript
        run: npm install -g @sourcegraph/scip-typescript

      - name: Generate SCIP Index
        run: scip-typescript index

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: scip-typescript-index
          path: commafeed-client/index.scip
          retention-days: 1

  upload:
    name: Upload SCIP Indexes
    runs-on: ubuntu-latest
    needs: [scip-java, scip-typescript]
    steps:
      - name: Check Out Code
        uses: actions/checkout@v6

      - name: Download Java Index
        uses: actions/download-artifact@v4
        with:
          name: scip-java-index
          path: java-index

      - name: Download TypeScript Index
        uses: actions/download-artifact@v4
        with:
          name: scip-typescript-index
          path: typescript-index

      - name: Upload Java Index
        uses: docker://sourcegraph/src-cli:latest
        with:
          args: code-intel upload -file=java-index/index.scip -github-token=${{ secrets.GITHUB_TOKEN }} -no-progress
        env:
          SRC_ENDPOINT: https://sourcegraph.com
          SRC_ACCESS_TOKEN: ${{ secrets.SRC_ACCESS_TOKEN }}

      - name: Upload TypeScript Index
        uses: docker://sourcegraph/src-cli:latest
        with:
          args: code-intel upload -file=typescript-index/index.scip -root=commafeed-client -github-token=${{ secrets.GITHUB_TOKEN }} -no-progress
        env:
          SRC_ENDPOINT: https://sourcegraph.com
          SRC_ACCESS_TOKEN: ${{ secrets.SRC_ACCESS_TOKEN }}
